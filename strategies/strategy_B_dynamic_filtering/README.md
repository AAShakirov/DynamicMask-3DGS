# Strategy B: Dynamic Filtering для 3D Gaussian Splatting

## Описание

Стратегия B - это комплексный подход к интеграции 2D-сегментационных масок в пайплайн 3D Gaussian Splatting для подавления артефактов, вызванных динамическими объектами (людьми, роботами и т.д.).

## Проблема

3D Gaussian Splatting (3DGS) создает высококачественные 3D-сцены, но крайне уязвим к динамическим объектам в обучающих изображениях. Наивный подход (обнуление loss на замаскированных пикселях) не решает проблему полностью, так как механизм адаптивной денсификации продолжает создавать лишние гауссианы в областях с высоким градиентом (движущиеся объекты).

## Компоненты стратегии

### (а) SfM Point Filtering
**Файл:** `sfm_filtering.py`

Фильтрует 3D-точки из Structure-from-Motion перед инициализацией гауссианов.

**Принцип работы:**
1. Проецирует каждую 3D-точку на все обучающие камеры
2. Проверяет, попадает ли точка на маску динамических объектов
3. Вычисляет долю "динамичных" наблюдений для каждой точки
4. Удаляет точки с долей выше порога (по умолчанию 50%)

**Параметры:**
- `--strategy_b_sfm_threshold`: порог фильтрации (0-1, default: 0.5)

### (б) Controlled Splitting
**Файл:** `controlled_splitting.py`

Модифицирует логику адаптивной денсификации для запрета создания гауссианов в динамических областях.

**Принцип работы:**
1. При клонировании/разделении гауссианов проецирует кандидатов на все камеры
2. Проверяет, попадают ли они на маски
3. Фильтрует кандидатов с высокой долей попаданий на динамические области
4. Выполняет денсификацию только для отфильтрованных гауссианов

**Параметры:**
- `--strategy_b_densify_threshold`: порог для блокировки денсификации (0-1, default: 0.3)

### (в) Dynamic Gaussian Pruning
**Файл:** `gaussian_pruning.py`

Периодически удаляет гауссианы, которые постоянно находятся в динамических областях.

**Принцип работы:**
1. Отслеживает проекции гауссианов на каждое обучающее изображение
2. Ведет статистику попаданий на маски
3. Периодически удаляет гауссианы с высокой долей попаданий
4. Использует адаптивный порог (уменьшается со временем)

**Параметры:**
- `--strategy_b_prune_threshold`: порог для удаления гауссианов (0-1, default: 0.7)
- `--strategy_b_prune_min_obs`: минимум наблюдений перед удалением (default: 10)

## Использование

### 1. Создание масок

Сначала создайте маски динамических объектов для ваших изображений:

```bash
python preprocessing/create_mask.py
```

Это создаст файлы `*_mask.npy` рядом с изображениями.

### 2. Запуск обучения со стратегией B

```bash
python train.py -s <path_to_dataset> \
  --use_strategy_b \
  --strategy_b_sfm_threshold 0.5 \
  --strategy_b_densify_threshold 0.3 \
  --strategy_b_prune_threshold 0.7 \
  --strategy_b_prune_min_obs 10
```

### Параметры командной строки

| Параметр | Описание | По умолчанию |
|----------|----------|--------------|
| `--use_strategy_b` | Включить стратегию B | False |
| `--strategy_b_sfm_threshold` | Порог фильтрации SfM точек | 0.5 |
| `--strategy_b_densify_threshold` | Порог блокировки денсификации | 0.3 |
| `--strategy_b_prune_threshold` | Порог удаления динамических гауссианов | 0.7 |
| `--strategy_b_prune_min_obs` | Минимум наблюдений для удаления | 10 |

## Архитектура

```
strategies/strategy_B_dynamic_filtering/
├── __init__.py                # Экспорт всех компонентов
├── sfm_filtering.py           # Компонент (а): Фильтрация SfM точек
├── controlled_splitting.py    # Компонент (б): Контролируемая денсификация
├── gaussian_pruning.py        # Компонент (в): Удаление динамических гауссианов
└── README.md                  # Эта документация
```

## Интеграция в код

### Модифицированные файлы

1. **train.py**
   - Импорт компонентов стратегии B
   - Инициализация `MaskAwareDensifier`, `DynamicGaussianTracker`, `AdaptivePruningScheduler`
   - Замена стандартной денсификации на `densify_and_prune_masked`
   - Обновление трекера на каждой итерации
   - Периодическое удаление динамических гауссианов

2. **scene/__init__.py**
   - Применение фильтрации SfM точек перед `create_from_pcd`

3. **scene/cameras.py**
   - Добавление поля `dynamic_mask` в класс `Camera`

4. **scene/dataset_readers.py**
   - Добавление поля `mask_path` в `CameraInfo`
   - Автоматическая загрузка путей к маскам

5. **utils/camera_utils.py**
   - Загрузка масок из `.npy` файлов
   - Изменение размера масок под разрешение камеры

6. **arguments/__init__.py**
   - Добавление параметров стратегии B в `ModelParams`

## Пример

```python
# Обучение с настройками по умолчанию
python train.py -s dataset/drjohnson --use_strategy_b

# Обучение с custom параметрами
python train.py -s dataset/drjohnson \
  --use_strategy_b \
  --strategy_b_sfm_threshold 0.6 \
  --strategy_b_densify_threshold 0.2 \
  --strategy_b_prune_threshold 0.8
```

## Ожидаемые результаты

- **Меньше гауссианов**: Фильтрация SfM точек и блокировка денсификации уменьшают количество гауссианов
- **Меньше артефактов**: Меньше "призраков" от движущихся объектов
- **Чище статические области**: Гауссианы концентрируются на статичных частях сцены
- **Стабильное обучение**: Периодическое удаление предотвращает накопление "плохих" гауссианов

## Настройка параметров

### Агрессивная фильтрация (для сцен с большим количеством движения)
```bash
--strategy_b_sfm_threshold 0.3 \
--strategy_b_densify_threshold 0.2 \
--strategy_b_prune_threshold 0.6
```

### Консервативная фильтрация (для сцен с небольшим движением)
```bash
--strategy_b_sfm_threshold 0.7 \
--strategy_b_densify_threshold 0.4 \
--strategy_b_prune_threshold 0.8
```

## Отладка

Стратегия B выводит информацию о своей работе в консоль:

```
[Strategy B-a] Points before filtering: 50000
[Strategy B-a] Points removed (dynamic): 5000 (10.0%)
[Strategy B-a] Points kept (static): 45000 (90.0%)

[Strategy B-b] Filtered 150 gaussians from densification (on dynamic areas)

[Strategy B-c] Pruning 250 dynamic gaussians (threshold=0.7, min_obs=10)
```

## Ограничения

1. Требует предварительно созданные маски (`*_mask.npy`)
2. Увеличивает время обучения (~10-20% медленнее)
3. Может чрезмерно удалить гауссианы при слишком агрессивных параметрах
4. Требует больше GPU памяти для хранения масок

## Сравнение со Стратегией A

| Аспект | Стратегия A (Loss Masking) | Стратегия B (Dynamic Filtering) |
|--------|----------------------------|----------------------------------|
| Простота | Проще | Сложнее |
| Скорость | Быстрее | Медленнее |
| Эффективность | Ограничена | Выше |
| Контроль денсификации | Нет | Да |
| Удаление артефактов | Частично | Полностью |

## Автор

Реализовано для проекта DynamicMask-3DGS
